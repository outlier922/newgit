<?php/** * Class AdminAction * 后台基础文件 */class AdminAction extends PublicAction {	//分页获取数据	protected function admin_get_page($field_list,$sql_suffix,$orderby_str){		$page_count = $GLOBALS['page_count'] ? $GLOBALS['page_count'] : SYS_PAGE_SIZE;		$page = _REQUEST('page');		$page = $page ? $page -1 : 0;		$start = $page * $page_count;		$orderby_str = $orderby_str ? $orderby_str : "mt.id desc";		$totalcount_sqlstr = "select count(*) $sql_suffix ";		$totalcount = $this -> get_one_bysql($totalcount_sqlstr);		$list_items = array();		if($totalcount){			$sqlstr = "select $field_list $sql_suffix order by $orderby_str limit $start,".$page_count;			$list_items = $this -> get_list_bysql($sqlstr);			if(SYS_DEBUG_MODE && !$list_items) die($sqlstr);		}		$GLOBALS['page_count'] = $page_count;		$GLOBALS['totalcount'] = $totalcount;		return $list_items;	}	//获取级联数据	protected function _cascade_get($parent_id,$mt,$where='1=1',$menu_orderby='order by orderby asc,id asc'){		$temp_array = array();		$menu_sqlstr = "select * from $mt where parentid=$parent_id and orderby=0 and $where $menu_orderby ";		$menu_r = $this -> get_list_bysql($menu_sqlstr);		for($i=0;$i<count($menu_r);$i++){			$menu_r_i = $menu_r[$i];			$id = $menu_r_i['id'];			$temp_array[$i] = $menu_r_i;			//检测是否有下级			$child_count = $this -> get_one_bysql("select count(*) from $mt where parentid=$id and $where $menu_orderby ");			if($child_count){				$temp_array[$i]['children'] = $this -> _cascade_get($id,$mt,$where,$menu_orderby);			}		}		return $temp_array;	}    //获取级联数据(角色管理)    protected function _cascade_get_role($parent_id,$mt,$where='1=1',$menu_orderby='order by id asc'){        $temp_array = array();        $menu_sqlstr = "select * from $mt where parentid=$parent_id and $where $menu_orderby ";        $menu_r = $this -> get_list_bysql($menu_sqlstr);        for($i=0;$i<count($menu_r);$i++){            $menu_r_i = $menu_r[$i];            $id = $menu_r_i['id'];            $temp_array[$i] = $menu_r_i;            //检测是否有下级            $child_count = $this -> get_one_bysql("select count(*) from $mt where parentid=$id and $where $menu_orderby ");            if($child_count){                $temp_array[$i]['children'] = $this -> _cascade_get_role($id,$mt,$where,$menu_orderby);            }        }        return $temp_array;    }		/**	+----------------------------------------------------------------------	| 全局方法	+----------------------------------------------------------------------	*/	//检测用户是否存在	protected function _client_exists($username,$clienttype=0){		if($clienttype === 0){			$client_count = $this -> get_one_bysql("select count(*) from sys_client where username='$username' ");		}		else{			$client_count = $this -> get_one_bysql("select count(*) from sys_client where username='$username' and clienttype='$clienttype'");		}		return $client_count>0 ? true : false;	}	//检测学校是否存在	protected function school_exists($username){		$count = $this -> get_one_bysql("select count(*) from sys_school where username='$username' ");		return $count > 0 ? true : false;	}	protected function school_exists_by_id($id){		$count = $this -> get_one_bysql("select count(*) from sys_school where id='$id' ");		return $count > 0 ? true : false;	}	//检测班级是否存在	protected function _class_exists($class_id){		$count = $this -> get_one_bysql("select count(*) from sys_class where id=$class_id ");		return $count > 0 ? true : false;	}	//图片列表	protected function _img_list($keytype,$keyid,$limit){		$sqlstr = "select * from sys_img where keytype=$keytype and keyid=$keyid $limit";		return $this -> get_list_bysql($sqlstr);	}	//检测管理员账号是否存在	protected function admin_exists($username){		$count = $this -> get_one_bysql("select count(*) from sys_admin where account='$username'");		return $count>0 ? true : false;	}	//检测分店管理员账号是否存在	protected function shop_admin_exists($username){		$count = $this -> get_one_bysql("select count(*) from sys_admin_shop where username='$username'");		return $count>0 ? true : false;	}	/**	+----------------------------------------------------------------------	|	+----------------------------------------------------------------------	*/	//角色数据	//角色select组件获取数据	public function role_select_list(){		$field_list = "mt.id,mt.name";		$sql_suffix = "from sys_role mt where 1=1 ";		$orderby_str = "order by mt.id asc";		$sqlstr = "select $field_list $sql_suffix $orderby_str";		$temp_array = $this -> get_list_bysql($sqlstr);		sys_out_success(0,$temp_array);	}	public function select_sex(){		$temp_array = array(			array('id'=>'1','name'=>'男'),			array('id'=>'2','name'=>'女')		);		sys_out_success(0,$temp_array);	}	public function set_agent(){		$temp_array = array(			array('id'=>'0','name'=>'否'),			array('id'=>'1','name'=>'是')		);		sys_out_success(0,$temp_array);	}	public function shop_role_select_list(){		$user = session('auth');		$shop_id=$user['shop_id'];		$field_list = "mt.id,mt.name";		$sql_suffix = "from sys_role_shop mt where mt.shop_id=$shop_id ";		$orderby_str = "order by mt.id asc";		$sqlstr = "select $field_list $sql_suffix $orderby_str";		$temp_array = $this -> get_list_bysql($sqlstr);		sys_out_success(0,$temp_array);	}	/**	+----------------------------------------------------------------------	| 公共模块	+----------------------------------------------------------------------	 */	//图片管理	public function image_list($_action_access=0){		//访问控制变量		$GLOBALS['_action_access'] = $_action_access;		$keytype = _REQUEST('keytype');		$keyid = _REQUEST('keyid');		$client_id = _REQUEST('client_id');		if (!empty($client_id))		{			$sqlstr = "select * from sys_img where keytype=$keytype and keyid=$keyid ";			$img_r = $this->get_list_bysql($sqlstr);		}		else $img_r = $this -> _img_list($keytype,$keyid,$client_id);		//UI部分		$buttons = array(			array('text'=>'添加','title'=>'添加图片','icon'=>'add2','full'=>0,'checked'=>0,'position'=>1,				'target'=>'inner_frame','url'=>U('Base/image_add'),'url_param' => array('keytype'=>'1_'.$keytype,'keyid'=>'1_'.$keyid)			),			array('text'=>'批量删除','title'=>'批量删除','icon'=>'del2','full'=>0,'checked'=>2,'position'=>1,				'target'=>'inner_confirm','url'=>U('Base/image_remove'),'url_param' => array('id'=>'2_id')			),			//array('text'=>'设为封面','title'=>'设为封面','icon'=>'del2','full'=>0,'checked'=>1,'position'=>1,			//	'target'=>'inner_confirm','url'=>U('Base/image_top_save'),'url_param' => array('id'=>'2_id','keytype'=>'1_'.$keytype,'keyid'=>'1_'.$keyid)			//),		);		$component_data = array(			'_parser'=>'container/default',			'_children'=>array(				array('_parser'=>'container/content',					'_children'=>array(						array('_parser'=>'button/top_button','_children'=>$buttons),						array('_parser'=>'table/datatables/images',							'data'=>&$img_r,						),					)				)			)		);		//解析组件		_display($component_data);	}	//图片管理	public function img_list($_action_access=0){		//访问控制变量		$GLOBALS['_action_access'] = $_action_access;		$keytype = _REQUEST('keytype');		$keyid = _REQUEST('keyid');		$client_id = _REQUEST('client_id');		if (!empty($client_id))		{			$sqlstr = "select * from sys_img where keytype=$keytype and keyid=$keyid ";			$img_r = $this->get_list_bysql($sqlstr);		}		else $img_r = $this -> _img_list($keytype,$keyid,$client_id);		//UI部分		$component_data = array(			'_parser'=>'container/default',			'_children'=>array(				array('_parser'=>'container/content',					'_children'=>array(						array('_parser'=>'table/datatables/images',							'data'=>&$img_r,						),					)				)			)		);		//解析组件		_display($component_data);	}		//添加图片	public function image_add(){		if(IS_POST){			$id = _POST('id');			$GLOBALS['cur_operate'] = $id ? 2 : 1;//目前的操作类型，2^0:新增;2^1:编辑			$keytype = _POST('keytype');			$keyid = _POST('keyid');			if($keytype == 1){				$num = 5;			}else if($keytype == 2){				$num = 4;			}			$count = $this->get_one_bysql("select count(*) from sys_img where keytype=$keytype and keyid=$keyid");			if($count >= $num){				sys_out_fail("最多只能上传".$num."张图片");			}			//图片			if (!empty($_FILES['temp_file']['name'])) {				$upload_array = sys_upload_file(1,240,240);				$imgurl = $upload_array[1];				$imgurlbig = $upload_array[0];			}			$sqlstr = "insert into sys_img set keytype=$keytype,keyid=$keyid,imgurl='$imgurl',imgurlbig='$imgurlbig',regdate='".sys_get_time()."'";			$result = $this -> do_execute($sqlstr);			sys_out_result($result);		}		else{			$keytype = _REQUEST('keytype');			$keyid = _REQUEST('keyid');			$GLOBALS['cur_operate'] =  1;//目前的操作类型，2^0:新增;2^1:编辑			$form_items = array(				array('name'=>'keytype','_parser'=>'form_item/form/hidden','value'=>$keytype),				array('name'=>'keyid','_parser'=>'form_item/form/hidden','value'=>$keyid),				array('name'=>'imgurl','label'=>'选择图片',					'_parser'=>'form_item/form/image','required'=>1,				),			);			form_validation_create($form_items,$rules,$messages);//获取验证规则			$component_data = array('_parser'=>'form/default',				'action' => U(MODULE_NAME.'/'.ACTION_NAME),'_children'=>$form_items,				'rules' => $rules,'messages' => $messages,			);			_display($component_data);					}	}	//设为封面图片	public function image_top_save(){		$id = _REQUEST('id');		$keytype = _REQUEST('keytype');		$keyid = _REQUEST('keyid');		$img_r = $this -> get_list_bysql("select imgurl,imgurlbig from sys_img where id=$id");		$imgurl = $img_r[0]['imgurl'];		$imgurlbig = $img_r[0]['imgurlbig'];		//更新封面		if($keytype == 2){			$sqlstr = "update sys_blog set imgurl='$imgurl',imgurlbig='$imgurlbig' where id=$keyid";		}		else if($keytype == 3){			$sqlstr = "update sys_resorts set imgurl='$imgurl',imgurlbig='$imgurlbig' where id=$keyid";		}		$result = $this -> do_execute($sqlstr);		sys_out_result($result);	}	//删除图片	public function image_remove(){		$id = _POST('id');		$sqlstr = "delete from sys_img where id in ($id) ";		$result = $this -> do_execute($sqlstr);		sys_out_result($result);	}}?>